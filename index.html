<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa MiRutaSS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map { 
      height: 100%; 
      margin: 0; 
      padding: 0; 
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script>
    // Límites de la provincia Sancti Spíritus
    const limitesProvinciaSanctiSpiritus = [
      [21.50, -80.20],
      [22.40, -79.00]
    ];

    // Coordenadas del centro de la provincia
    const centroProvincia = [21.93, -79.45];

    // Crear mapa
    var map = L.map('map').setView(centroProvincia, 10);

    // Establecer límites del mapa
    map.setMaxBounds(limitesProvinciaSanctiSpiritus);
    map.on('drag', function() {
      map.panInsideBounds(limitesProvinciaSanctiSpiritus, { animate: false });
    });

    // Capa de mapa
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      minZoom: 9,
      attribution: '© OpenStreetMap',
      bounds: limitesProvinciaSanctiSpiritus
    }).addTo(map);

    var rutaControl = null;
    var markerOrigen = null;
    var markerDestino = null;

    // Función para verificar límites
    function estaDentroDeLimites(lat, lng) {
      return lat >= limitesProvinciaSanctiSpiritus[0][0] && 
             lat <= limitesProvinciaSanctiSpiritus[1][0] && 
             lng >= limitesProvinciaSanctiSpiritus[0][1] && 
             lng <= limitesProvinciaSanctiSpiritus[1][1];
    }

    // Función para buscar dentro de límites
    function buscarDentroDeLimites(direccion) {
      const bounds = limitesProvinciaSanctiSpiritus;
      const viewbox = `${bounds[0][1]},${bounds[0][0]},${bounds[1][1]},${bounds[1][0]}`;

      return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}&limit=1&viewbox=${viewbox}&bounded=1`)
        .then(res => res.json())
        .then(data => {
          if (data && data.length > 0) {
            const resultado = data[0];
            if (estaDentroDeLimites(parseFloat(resultado.lat), parseFloat(resultado.lon))) {
              return resultado;
            }
          }
          throw new Error(`"${direccion}" no encontrado dentro de la provincia`);
        });
    }

    // Función principal para mostrar direcciones
    function mostrarDireccionesEnMapa(origen, destino) {
      // Limpiar marcadores previos
      if (markerOrigen) map.removeLayer(markerOrigen);
      if (markerDestino) map.removeLayer(markerDestino);
      if (rutaControl) map.removeControl(rutaControl);

      // Buscar ambas ubicaciones
      Promise.all([
        buscarDentroDeLimites(origen),
        buscarDentroDeLimites(destino)
      ])
      .then(([dataOrigen, dataDestino]) => {
        const coordsOrigen = L.latLng(
          parseFloat(dataOrigen.lat),
          parseFloat(dataOrigen.lon)
        );
        
        const coordsDestino = L.latLng(
          parseFloat(dataDestino.lat),
          parseFloat(dataDestino.lon)
        );

        // Crear marcadores
        markerOrigen = L.marker(coordsOrigen)
          .addTo(map)
          .bindPopup(`<b>Origen:</b><br>${origen}`);

        markerDestino = L.marker(coordsDestino)
          .addTo(map)
          .bindPopup(`<b>Destino:</b><br>${destino}`);

        // Crear ruta
        rutaControl = L.Routing.control({
          waypoints: [coordsOrigen, coordsDestino],
          lineOptions: { 
            styles: [{ 
              color: '#2196F3', 
              weight: 6,
              opacity: 0.8 
            }] 
          },
          createMarker: () => null,
          addWaypoints: false,
          routeWhileDragging: false,
          show: false
        }).addTo(map);

        // Ajustar vista para ver ambos puntos
        const group = new L.featureGroup([markerOrigen, markerDestino]);
        map.fitBounds(group.getBounds().pad(0.1));

        // Evento cuando se encuentra la ruta
        rutaControl.on('routesfound', function(e) {
          const ruta = e.routes[0];
          const distanciaKm = ruta.summary.totalDistance / 1000;
          
          // Notificar a Android de la distancia (sin precio)
          if (window.Android && window.Android.setDistancia) {
            window.Android.setDistancia(distanciaKm.toFixed(1));
          }
        });

      })
      .catch(error => {
        console.error('Error:', error);
        // Notificar error a Android
        if (window.Android && window.Android.errorMapa) {
          window.Android.errorMapa(error.message);
        }
      });
    }

    // Función para limpiar todo el mapa
    function borrarRutaDesdeApp() {
      if (markerOrigen) { 
        map.removeLayer(markerOrigen); 
        markerOrigen = null; 
      }
      
      if (markerDestino) { 
        map.removeLayer(markerDestino); 
        markerDestino = null; 
      }
      
      if (rutaControl) { 
        map.removeControl(rutaControl); 
        rutaControl = null; 
      }
      
      // Notificar a Android
      if (window.Android && window.Android.rutaBorrada) {
        window.Android.rutaBorrada();
      }
    }

    // Función para restaurar vista inicial
    function restaurarVista() {
      map.setView(centroProvincia, 10);
    }

    // Hacer funciones disponibles globalmente
    window.mostrarDireccionesEnMapa = mostrarDireccionesEnMapa;
    window.borrarRutaDesdeApp = borrarRutaDesdeApp;
    window.restaurarVista = restaurarVista;

  </script>
</body>
</html>