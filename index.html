<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa MiRutaSS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map { 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #marcador-centro {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin-left: -10px;
      margin-top: -10px;
      border-radius: 50%;
      background: #6764FD;
      border: 2px solid white;
      box-shadow: 0 0 10px #6764FD;
      z-index: 999;
      pointer-events: none;
      display: none;
    }

    /* Layout transparente inferior - MÁS COMPACTO */
    #botones-layout {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(0,0,0,0.7);
      padding: 12px 16px; /* Reducido */
      border-radius: 18px; /* Ligeramente más pequeño */
      display: flex;
      flex-direction: row;
      gap: 16px; /* Reducido el espacio entre botones */
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      max-width: 90%; /* Asegura que no sobrepase los bordes */
    }

    /* Contenedor para cada botón con su etiqueta */
    .boton-contenedor {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px; /* Reducido */
      transition: transform 0.2s ease;
    }

    .boton-contenedor:hover {
      transform: translateY(-3px);
    }

    /* Botones circulares - MÁS PEQUEÑOS */
    .boton-mapa {
      width: 50px; /* Reducido de 60px */
      height: 50px; /* Reducido de 60px */
      border-radius: 50%;
      background: linear-gradient(135deg, #6764FD, #4b48c9);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .boton-mapa::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
      border-radius: 50%;
    }

    .boton-mapa:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(103, 100, 253, 0.5);
    }

    .boton-mapa:active {
      transform: scale(1.05);
    }

    /* Iconos SVG - MÁS PEQUEÑOS */
    .icono-boton {
      width: 22px; /* Reducido de 26px */
      height: 22px; /* Reducido de 26px */
      fill: white;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
      transition: transform 0.2s ease;
    }

    .boton-mapa:hover .icono-boton {
      transform: scale(1.1);
    }

    /* Etiquetas de texto debajo de los botones */
    .etiqueta-boton {
      color: white;
      font-size: 12px; /* Ligeramente más pequeño */
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      white-space: nowrap;
      letter-spacing: 0.3px;
    }

    /* Indicador de modo activo */
    .modo-activo {
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8), 0 6px 16px rgba(103, 100, 253, 0.6);
    }

    /* Animación para el marcador de centro */
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .marcador-activo {
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="marcador-centro"></div>

  <!-- Layout transparente con los botones - MÁS COMPACTO -->
  <div id="botones-layout">
    <div class="boton-contenedor">
      <button id="btn-origen" onclick="toggleOrigen()" class="boton-mapa" title="Fijar origen">
        <svg class="icono-boton" viewBox="0 0 24 24">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
      </button>
      <span class="etiqueta-boton">Origen</span>
    </div>
    <div class="boton-contenedor">
      <button id="btn-destino" onclick="toggleDestino()" class="boton-mapa" title="Fijar destino">
        <svg class="icono-boton" viewBox="0 0 24 24">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm-1 11.5v-6h2v6h-2z"/>
          <circle cx="12" cy="9" r="1.5"/>
        </svg>
      </button>
      <span class="etiqueta-boton">Destino</span>
    </div>
    <div class="boton-contenedor">
      <button onclick="borrarRutaDesdeApp()" class="boton-mapa" title="Borrar ruta">
        <svg class="icono-boton" viewBox="0 0 24 24">
          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
        </svg>
      </button>
      <span class="etiqueta-boton">Borrar ruta</span>
    </div>
    <div class="boton-contenedor">
      <button onclick="restaurarUbicacion()" class="boton-mapa" title="Restaurar ubicación">
        <svg class="icono-boton" viewBox="0 0 24 24">
          <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
        </svg>
      </button>
      <span class="etiqueta-boton">Localización</span>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script>
    var map = L.map('map').setView([21.9276, -79.4432], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    var rutaControl = null;
    var markerUbicacion = null;
    var marcadorOrigen = null;
    var marcadorDestino = null;
    var direccionDetectada = "";
    var coordenadasUbicacion = null;
    var origenModificado = false;
    var modoSeleccion = null;
    var seleccionandoOrigen = false;
    var seleccionandoDestino = false;

    function toggleOrigen() {
      if (!seleccionandoOrigen) {
        seleccionandoOrigen = true;
        seleccionandoDestino = false;
        document.getElementById('btn-origen').classList.add('modo-activo');
        document.getElementById('marcador-centro').classList.add('marcador-activo');
        activarMarcadorFlotante('origen');
      } else {
        seleccionandoOrigen = false;
        document.getElementById('btn-origen').classList.remove('modo-activo');
        document.getElementById('marcador-centro').classList.remove('marcador-activo');
        confirmarMarcadorFlotante('origen');
        eliminarUbicacion();
      }
    }

    function toggleDestino() {
      if (!seleccionandoDestino) {
        seleccionandoDestino = true;
        seleccionandoOrigen = false;
        document.getElementById('btn-destino').classList.add('modo-activo');
        document.getElementById('marcador-centro').classList.add('marcador-activo');
        activarMarcadorFlotante('destino');
      } else {
        seleccionandoDestino = false;
        document.getElementById('btn-destino').classList.remove('modo-activo');
        document.getElementById('marcador-centro').classList.remove('marcador-activo');
        confirmarMarcadorFlotante('destino');
      }
    }

    function detectarUbicacion() {
      map.locate({ setView: true, maxZoom: 16 });
    }

    map.on('locationfound', function(e) {
      coordenadasUbicacion = [e.latitude, e.longitude];
      if (markerUbicacion) map.removeLayer(markerUbicacion);
      markerUbicacion = L.marker(e.latlng).addTo(map).bindPopup('Tu ubicación').openPopup();
      
      // CREAR MARCADOR DE ORIGEN AUTOMÁTICAMENTE CON LA GEOLOCALIZACIÓN
      if (!marcadorOrigen && !origenModificado) {
        marcadorOrigen = L.marker(e.latlng).addTo(map).bindPopup('Origen automático');
      }
      
      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + e.latitude + '&lon=' + e.longitude)
        .then(res => res.json())
        .then(data => {
          if (data && data.display_name) {
            direccionDetectada = data.display_name;
            if (!origenModificado && window.Android && window.Android.setOrigen) {
              window.Android.setOrigen(direccionDetectada);
            }
          }
        });
    });

    map.on('locationerror', function() {
      alert('No se pudo obtener tu ubicación');
    });

    function eliminarUbicacion() {
      origenModificado = true;
      if (markerUbicacion) {
        map.removeLayer(markerUbicacion);
        markerUbicacion = null;
      }
    }

    function restaurarUbicacion() {
      origenModificado = false;
      if (rutaControl) { map.removeControl(rutaControl); rutaControl = null; }
      if (marcadorOrigen) { map.removeLayer(marcadorOrigen); marcadorOrigen = null; }
      if (marcadorDestino) { map.removeLayer(marcadorDestino); marcadorDestino = null; }
      detectarUbicacion();
    }

    function activarMarcadorFlotante(tipo) {
      modoSeleccion = tipo;
      document.getElementById("marcador-centro").style.display = "block";
    }

    function confirmarMarcadorFlotante(tipo) {
      var coords = map.getCenter();
      document.getElementById("marcador-centro").style.display = "none";
      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + coords.lat + '&lon=' + coords.lng)
        .then(res => res.json())
        .then(data => {
          if (data && data.display_name) {
            var direccion = data.display_name;
            if (tipo === 'origen') {
              if (marcadorOrigen) map.removeLayer(marcadorOrigen);
              marcadorOrigen = L.marker(coords).addTo(map).bindPopup('Origen').openPopup();
              if (window.Android && window.Android.setOrigen) window.Android.setOrigen(direccion);
            } else if (tipo === 'destino') {
              if (marcadorDestino) map.removeLayer(marcadorDestino);
              marcadorDestino = L.marker(coords).addTo(map).bindPopup('Destino').openPopup();
              if (window.Android && window.Android.setDestino) window.Android.setDestino(direccion);
            }
            
            // CREAR RUTA AUTOMÁTICAMENTE SI HAY ORIGEN Y DESTINO
            crearRutaSiEsNecesario();
            modoSeleccion = null;
          }
        });
    }

    // NUEVA FUNCIÓN: CREAR RUTA AUTOMÁTICAMENTE
    function crearRutaSiEsNecesario() {
      var origen = obtenerOrigenActual();
      var destino = marcadorDestino ? marcadorDestino.getLatLng() : null;
      
      if (origen && destino) {
        if (rutaControl) map.removeControl(rutaControl);
        rutaControl = L.Routing.control({
          waypoints: [origen, destino],
          lineOptions: { styles: [{ color: '#6764FD', weight: 5 }] },
          createMarker: () => null,
          addWaypoints: false,
          routeWhileDragging: false
        }).addTo(map);
      }
    }

    // NUEVA FUNCIÓN: OBTENER ORIGEN ACTUAL (AUTOMÁTICO O MANUAL)
    function obtenerOrigenActual() {
      if (marcadorOrigen) {
        return marcadorOrigen.getLatLng();
      } else if (coordenadasUbicacion && !origenModificado) {
        return L.latLng(coordenadasUbicacion[0], coordenadasUbicacion[1]);
      }
      return null;
    }

    function borrarRutaDesdeApp() {
      if (rutaControl || marcadorOrigen || marcadorDestino) {
        if (rutaControl) {
          map.removeControl(rutaControl);
          rutaControl = null;
        }
        // CORRECCIÓN: ELIMINAR SIEMPRE EL MARCADOR DE ORIGEN, SIN IMPORTAR SI ES AUTOMÁTICO O MANUAL
        if (marcadorOrigen) { 
          map.removeLayer(marcadorOrigen); 
          marcadorOrigen = null; 
        }
        if (marcadorDestino) { 
          map.removeLayer(marcadorDestino); 
          marcadorDestino = null; 
        }
        // CORRECCIÓN: RESETEAR EL ESTADO DE ORIGEN MODIFICADO
        origenModificado = false;
        alert("Ruta eliminada correctamente");
      } else {
        alert("No existe una ruta definitiva que borrar.");
      }
    }

    detectarUbicacion();
  </script>
</body>
</html>