<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa MiRutaSS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #marcador-centro {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin-left: -10px;
      margin-top: -10px;
      border-radius: 50%;
      background: #6764FD;
      border: 2px solid white;
      box-shadow: 0 0 10px #6764FD;
      z-index: 999;
      pointer-events: none;
      display: none;
    }
    #botones-mapa {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .boton-mapa {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: #6764FD;
      color: white;
      border: none;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease;
    }
    .boton-mapa:hover {
      background-color: #4b48c9;
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="marcador-centro"></div>
  <div id="botones-mapa">
    <button onclick="toggleOrigen()" class="boton-mapa" title="Fijar origen">üìç</button>
    <button onclick="toggleDestino()" class="boton-mapa" title="Fijar destino">üéØ</button>
    <button onclick="borrarRutaDesdeApp()" class="boton-mapa" title="Borrar ruta">üóëÔ∏è</button>
    <button onclick="restaurarUbicacion()" class="boton-mapa" title="Restaurar ubicaci√≥n">üîÑ</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script>
    var map = L.map('map').setView([21.9276, -79.4432], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    var rutaControl = null;
    var markerUbicacion = null;
    var marcadorOrigen = null;
    var marcadorDestino = null;
    var direccionDetectada = "";
    var coordenadasUbicacion = null;
    var origenModificado = false;
    var modoSeleccion = null;
    var seleccionandoOrigen = false;
    var seleccionandoDestino = false;

    function toggleOrigen() {
      if (!seleccionandoOrigen) {
        seleccionandoOrigen = true;
        seleccionandoDestino = false;
        activarMarcadorFlotante('origen');
      } else {
        seleccionandoOrigen = false;
        confirmarMarcadorFlotante('origen');
        eliminarUbicacion();
      }
    }

    function toggleDestino() {
      if (!seleccionandoDestino) {
        seleccionandoDestino = true;
        seleccionandoOrigen = false;
        activarMarcadorFlotante('destino');
      } else {
        seleccionandoDestino = false;
        confirmarMarcadorFlotante('destino');
      }
    }

    function detectarUbicacion() {
      map.locate({ setView: true, maxZoom: 16 });
    }

    map.on('locationfound', function(e) {
      coordenadasUbicacion = [e.latitude, e.longitude];

      if (markerUbicacion) {
        map.removeLayer(markerUbicacion);
      }

      markerUbicacion = L.marker(e.latlng).addTo(map).bindPopup('Tu ubicaci√≥n').openPopup();

      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + e.latitude + '&lon=' + e.longitude)
        .then(res => res.json())
        .then(data => {
          if (data && data.display_name) {
            direccionDetectada = data.display_name;

            if (!origenModificado && window.Android && window.Android.setOrigen) {
              window.Android.setOrigen(direccionDetectada);
            }
          }
        });
    });

    map.on('locationerror', function() {
      alert('No se pudo obtener tu ubicaci√≥n');
    });

    function eliminarUbicacion() {
      origenModificado = true;
      if (markerUbicacion) {
        map.removeLayer(markerUbicacion);
        markerUbicacion = null;
      }
    }

    function restaurarUbicacion() {
      origenModificado = false;

      if (rutaControl) {
        map.removeControl(rutaControl);
        rutaControl = null;
      }

      if (marcadorOrigen) {
        map.removeLayer(marcadorOrigen);
        marcadorOrigen = null;
      }
      if (marcadorDestino) {
        map.removeLayer(marcadorDestino);
        marcadorDestino = null;
      }

      detectarUbicacion();
    }

    function activarMarcadorFlotante(tipo) {
      modoSeleccion = tipo;
      document.getElementById("marcador-centro").style.display = "block";
    }

    function confirmarMarcadorFlotante(tipo) {
      var coords = map.getCenter();
      document.getElementById("marcador-centro").style.display = "none";

      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + coords.lat + '&lon=' + coords.lng)
        .then(res => res.json())
        .then(data => {
          if (data && data.display_name) {
            var direccion = data.display_name;

            if (tipo === 'origen') {
              if (marcadorOrigen) map.removeLayer(marcadorOrigen);
              marcadorOrigen = L.marker(coords).addTo(map).bindPopup('Origen').openPopup();
              if (window.Android && window.Android.setOrigen) {
                window.Android.setOrigen(direccion);
              }
            } else if (tipo === 'destino') {
              if (marcadorDestino) map.removeLayer(marcadorDestino);
              marcadorDestino = L.marker(coords).addTo(map).bindPopup('Destino').openPopup();
              if (window.Android && window.Android.setDestino) {
                window.Android.setDestino(direccion);
              }
            }

            if (marcadorOrigen && marcadorDestino) {
              if (rutaControl) map.removeControl(rutaControl);
              rutaControl = L.Routing.control({
                waypoints: [
                  marcadorOrigen.getLatLng(),
                  marcadorDestino.getLatLng()
                ],
                lineOptions: {
                  styles: [{ color: '#6764FD', weight: 5 }]
                },
                createMarker: () => null,
                addWaypoints: false,
                routeWhileDragging: false
              }).addTo(map);
            }

            modoSeleccion = null;
          }
        });
    }

    function borrarRutaDesdeApp() {
      if (rutaControl) {
        map.removeControl(rutaControl);
        rutaControl = null;

        if (marcadorOrigen) {
          map.removeLayer(marcadorOrigen);
          marcadorOrigen = null;
        }
        if (marcadorDestino) {
          map.removeLayer(marcadorDestino);
          marcadorDestino = null;
        }

        alert("Ruta eliminada correctamente");
      } else {
        alert("No existe una ruta definitiva que borrar.");
      }
    }

    detectarUbicacion();
  </script>
</body>
</html>