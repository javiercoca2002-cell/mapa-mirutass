<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa MiRutaSS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .marcador-flotante {
      font-size: 28px;
      color: #4466FF;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script>
    var map = L.map('map').setView([21.9276, -79.4432], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    var rutaControl = null;
    var markerUbicacion = null;
    var marcadorOrigen = null;
    var marcadorDestino = null;
    var direccionDetectada = "";
    var coordenadasUbicacion = null;
    var origenModificado = false;

    var modoMarcacion = null;
    var marcadorFijo = null;

    function detectarUbicacion() {
      map.locate({ setView: true, maxZoom: 16 });
    }

    map.on('locationfound', function(e) {
      coordenadasUbicacion = [e.latitude, e.longitude];

      if (markerUbicacion) {
        map.removeLayer(markerUbicacion);
      }

      markerUbicacion = L.marker(e.latlng).addTo(map).bindPopup('Tu ubicación').openPopup();

      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + e.latitude + '&lon=' + e.longitude)
        .then(res => res.json())
        .then(data => {
          if (data && data.display_name) {
            direccionDetectada = data.display_name;

            if (!origenModificado && window.Android && window.Android.setOrigen) {
              window.Android.setOrigen(direccionDetectada);
            }
          }
        });
    });

    map.on('locationerror', function() {
      alert('No se pudo obtener tu ubicación');
    });

    function eliminarUbicacion() {
      origenModificado = true;
      if (markerUbicacion) {
        map.removeLayer(markerUbicacion);
        markerUbicacion = null;
      }
    }

    function restaurarUbicacion() {
      origenModificado = false;

      if (rutaControl) {
        map.removeControl(rutaControl);
        rutaControl = null;
      }

      if (marcadorOrigen) {
        map.removeLayer(marcadorOrigen);
        marcadorOrigen = null;
      }
      if (marcadorDestino) {
        map.removeLayer(marcadorDestino);
        marcadorDestino = null;
      }

      detectarUbicacion();
    }

    function activarMarcador(tipo) {
      if (modoMarcacion === tipo) {
        confirmarMarcacion();
        return;
      }

      modoMarcacion = tipo;

      if (!marcadorFijo) {
        marcadorFijo = L.marker(map.getCenter(), {
          icon: L.divIcon({
            className: 'marcador-flotante',
            html: '📍',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
          })
        }).addTo(map);
      }

      alert("Mueve el mapa hasta posicionar el marcador sobre el punto deseado. Luego toca el botón nuevamente para confirmar.");
    }

    function confirmarMarcacion() {
      if (!modoMarcacion || !marcadorFijo) return;

      var latlng = map.getCenter();

      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + latlng.lat + '&lon=' + latlng.lng)
        .then(res => res.json())
        .then(data => {
          var direccion = data.display_name || "Dirección no encontrada";

          if (modoMarcacion === "origen") {
            if (marcadorOrigen) map.removeLayer(marcadorOrigen);
            marcadorOrigen = L.marker(latlng).addTo(map).bindPopup("Origen").openPopup();
            if (window.Android && window.Android.setOrigen) {
              window.Android.setOrigen(direccion);
            }
          } else if (modoMarcacion === "destino") {
            if (marcadorDestino) map.removeLayer(marcadorDestino);
            marcadorDestino = L.marker(latlng).addTo(map).bindPopup("Destino").openPopup();
            if (window.Android && window.Android.setDestino) {
              window.Android.setDestino(direccion);
            }
          }

          if (marcadorOrigen && marcadorDestino) {
            if (rutaControl) map.removeControl(rutaControl);
            rutaControl = L.Routing.control({
              waypoints: [
                marcadorOrigen.getLatLng(),
                marcadorDestino.getLatLng()
              ],
              lineOptions: {
                styles: [{ color: '#6764FD', weight: 5 }]
              },
              createMarker: function() { return null; },
              addWaypoints: false,
              routeWhileDragging: false
            }).addTo(map);
          }

          map.removeLayer(marcadorFijo);
          marcadorFijo = null;
          modoMarcacion = null;
        });
    }

    function marcarDesdeApp(origen, destino) {
      function buscarCoordenadas(direccion, callback) {
        fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(direccion) +
              '&countrycodes=cu&viewbox=-79.5000,21.9500,-79.4000,21.9000&bounded=1')
          .then(res => res.json())
          .then(data => {
            if (data.length > 0) {
              var lat = parseFloat(data[0].lat);
              var lon = parseFloat(data[0].lon);
              callback([lat, lon]);
            } else {
              callback(null);
            }
          });
      }

      if (marcadorOrigen) {
        map.removeLayer(marcadorOrigen);
        marcadorOrigen = null;
      }
      if (marcadorDestino) {
        map.removeLayer(marcadorDestino);
        marcadorDestino = null;
      }

      if (origen === direccionDetectada && coordenadasUbicacion) {
        marcadorOrigen = markerUbicacion;

        buscarCoordenadas(destino, function(puntoDestino) {
          if (puntoDestino) {
            marcadorDestino = L.marker(puntoDestino).addTo(map).bindPopup('Destino').openPopup();

            if (rutaControl) {
              map.removeControl(rutaControl);
            }

            rutaControl = L.Routing.control({
              waypoints: [
                L.latLng(coordenadasUbicacion[0], coordenadasUbicacion[1]),
                L.latLng(puntoDestino[0], puntoDestino[1])
              ],
              lineOptions: {
                styles: [{ color: '#6764FD', weight: 5 }]
              },
              createMarker: function() { return null; },
              addWaypoints: false,
              routeWhileDragging: false
            }).addTo(map);
          }
        });

      } else {
        buscarCoordenadas(origen, function(puntoOrigen) {
          if (puntoOrigen) {
            marcadorOrigen = L.marker(puntoOrigen).addTo(map).bindPopup('Origen').openPopup();
            map.setView(puntoOrigen, 14);

            buscarCoordenadas(destino, function(puntoDestino) {
              if (puntoDestino) {
                marcadorDestino = L.marker(puntoDestino).addTo(map).bindPopup('Destino').openPopup();

                if (rutaControl) {
                  map.removeControl(rutaControl);
                }

                rutaControl = L.Routing.control({
                  waypoints: [
                    L.latLng(puntoOrigen[0], puntoOrigen[1]),
                    L.latLng(puntoDestino[0], puntoDestino[1])
                  ],
                  lineOptions: {
                    styles: [{ color: '#6764FD', weight: 5 }]
                  },
                  createMarker: function() { return null; },
                  addWaypoints: false,
                  routeWhileDragging: false
                }).addTo(map);
              }
            });
          }
        });
      }
    }

    function borrarRutaDesdeApp() {
      if (rutaControl) {
        map.removeControl(rutaControl);
        rutaControl = null;

        if (marcadorOrigen) {
          map.removeLayer(marcadorOrigen);
          marcadorOrigen = null;
        }