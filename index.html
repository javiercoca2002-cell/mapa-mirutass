<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa MiRutaSS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map { 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #marcador-centro {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin-left: -10px;
      margin-top: -10px;
      border-radius: 50%;
      background: #6764FD;
      border: 2px solid white;
      box-shadow: 0 0 10px #6764FD;
      z-index: 999;
      pointer-events: none;
      display: none;
    }

    /* Layout transparente inferior - MS COMPACTO */
    #botones-layout {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(0,0,0,0.7);
      padding: 12px 16px;
      border-radius: 18px;
      display: flex;
      flex-direction: row;
      gap: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      max-width: 90%;
    }

    /* Contenedor para cada bot贸n con su etiqueta */
    .boton-contenedor {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      transition: transform 0.2s ease;
    }

    .boton-contenedor:hover {
      transform: translateY(-3px);
    }

    /* Botones circulares - MS PEQUEOS */
    .boton-mapa {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6764FD, #4b48c9);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .boton-mapa::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
      border-radius: 50%;
    }

    .boton-mapa:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(103, 100, 253, 0.5);
    }

    .boton-mapa:active {
      transform: scale(1.05);
    }

    /* Iconos SVG - MS PEQUEOS */
    .icono-boton {
      width: 22px;
      height: 22px;
      fill: white;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
      transition: transform 0.2s ease;
    }

    .boton-mapa:hover .icono-boton {
      transform: scale(1.1);
    }

    /* Etiquetas de texto debajo de los botones */
    .etiqueta-boton {
      color: white;
      font-size: 12px;
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      white-space: nowrap;
      letter-spacing: 0.3px;
    }

    /* Indicador de modo activo */
    .modo-activo {
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8), 0 6px 16px rgba(103, 100, 253, 0.6);
    }

    /* Animaci贸n para el marcador de centro */
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .marcador-activo {
      animation: pulse 1.5s infinite;
    }

    /* MEJORAS AGREGADAS */

    /* Loading State */
    #loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      transition: opacity 0.3s ease;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #6764FD;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    .loading-text {
      color: #333;
      font-size: 14px;
      font-weight: 500;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Notificaciones mejoradas */
    .custom-alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      opacity: 0;
    }

    .custom-alert.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Mejoras de accesibilidad */
    .boton-mapa:focus {
      outline: 2px solid rgba(255,255,255,0.5);
      outline-offset: 2px;
    }

    /* Estados de carga mejorados */
    .loading-state {
      opacity: 0.7;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <!-- Loading Screen Mejorado -->
  <div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Cargando mapa...</div>
  </div>

  <!-- Sistema de Notificaciones -->
  <div id="customAlert" class="custom-alert"></div>

  <div id="map"></div>
  <div id="marcador-centro"></div>

  <!-- Layout transparente con los botones - MS COMPACTO -->
  <div id="botones-layout">
    <div class="boton-contenedor">
      <button id="btn-origen" onclick="toggleOrigen()" class="boton-mapa" title="Fijar origen">
        <svg class="icono-boton" viewBox="0 0 24 24">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
      </button>
      <span class="etiqueta-boton">Origen</span>
    </div>
    <div class="boton-contenedor">
      <button id="btn-destino" onclick="toggleDestino()" class="boton-mapa" title="Fijar destino">
        <svg class="icono-boton" viewBox="0 0 24 24">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm-1 11.5v-6h2v6h-2z"/>
          <circle cx="12" cy="9" r="1.5"/>
        </svg>
      </button>
      <span class="etiqueta-boton">Destino</span>
    </div>
    <div class="boton-contenedor">
      <button onclick="borrarRutaDesdeApp()" class="boton-mapa" title="Borrar ruta">
        <svg class="icono-boton" viewBox="0 0 24 24">
          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
        </svg>
      </button>
      <span class="etiqueta-boton">Borrar ruta</span>
    </div>
    <div class="boton-contenedor">
      <button onclick="restaurarUbicacion()" class="boton-mapa" title="Restaurar ubicaci贸n">
        <svg class="icono-boton" viewBox="0 0 24 24">
          <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
        </svg>
      </button>
      <span class="etiqueta-boton">Localizaci贸n</span>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script>
    // MEJORA: Sistema de notificaciones
    function mostrarNotificacion(mensaje, tipo = 'info') {
      const alert = document.getElementById('customAlert');
      alert.textContent = mensaje;
      alert.className = 'custom-alert';

      if (tipo === 'error') {
        alert.style.background = 'rgba(255, 71, 87, 0.9)';
      } else if (tipo === 'success') {
        alert.style.background = 'rgba(46, 213, 115, 0.9)';
      }

      alert.classList.add('show');

      setTimeout(() => {
        alert.classList.remove('show');
      }, 3000);
    }

    // MEJORA: Loading state management
    function mostrarLoading() {
      document.getElementById('loading-overlay').style.display = 'flex';
      setTimeout(() => {
        document.getElementById('loading-overlay').style.opacity = '1';
      }, 10);
    }

    function ocultarLoading() {
      document.getElementById('loading-overlay').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('loading-overlay').style.display = 'none';
      }, 300);
    }

    // MEJORA: Inicializaci贸n mejorada del mapa
    mostrarLoading();

    var map = L.map('map').setView([21.9276, -79.4432], 14);

    // MEJORA: Manejo de errores en carga de tiles
    var tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '漏 OpenStreetMap'
    }).addTo(map);

    tileLayer.on('load', function() {
      setTimeout(ocultarLoading, 500);
    });

    tileLayer.on('tileerror', function() {
      mostrarNotificacion('Error cargando el mapa. Verifica tu conexi贸n.', 'error');
    });

    var rutaControl = null;
    var markerUbicacion = null; // nico marcador para ubicaci贸n/origen
    var marcadorDestino = null;
    var direccionDetectada = "";
    var coordenadasUbicacion = null;
    var origenModificado = false;
    var modoSeleccion = null;
    var seleccionandoOrigen = false;
    var seleccionandoDestino = false;

    // MEJORA: Funci贸n mejorada con notificaciones
    function toggleOrigen() {
      if (!seleccionandoOrigen) {
        seleccionandoOrigen = true;
        seleccionandoDestino = false;
        document.getElementById('btn-origen').classList.add('modo-activo');
        document.getElementById('marcador-centro').classList.add('marcador-activo');
        activarMarcadorFlotante('origen');
        mostrarNotificacion('Selecciona el punto de origen en el mapa');
      } else {
        seleccionandoOrigen = false;
        document.getElementById('btn-origen').classList.remove('modo-activo');
        document.getElementById('marcador-centro').classList.remove('marcador-activo');
        confirmarMarcadorFlotante('origen');
        eliminarUbicacion();
      }
    }

    // MEJORA: Funci贸n mejorada con notificaciones
    function toggleDestino() {
      if (!seleccionandoDestino) {
        seleccionandoDestino = true;
        seleccionandoOrigen = false;
        document.getElementById('btn-destino').classList.add('modo-activo');
        document.getElementById('marcador-centro').classList.add('marcador-activo');
        activarMarcadorFlotante('destino');
        mostrarNotificacion('Selecciona el punto de destino en el mapa');
      } else {
        seleccionandoDestino = false;
        document.getElementById('btn-destino').classList.remove('modo-activo');
        document.getElementById('marcador-centro').classList.remove('marcador-activo');
        confirmarMarcadorFlotante('destino');
      }
    }

    function detectarUbicacion() {
      map.locate({ setView: true, maxZoom: 16 });
    }

    map.on('locationfound', function(e) {
      coordenadasUbicacion = [e.latitude, e.longitude];
      
      // SOLO crear marcador si no hay uno existente y no se ha modificado manualmente
      if (!markerUbicacion && !origenModificado) {
        markerUbicacion = L.marker(e.latlng).addTo(map).bindPopup('Tu ubicaci贸n').openPopup();
      }
      
      // Actualizar la ubicaci贸n del marcador existente si es la ubicaci贸n autom谩tica
      else if (markerUbicacion && !origenModificado) {
        markerUbicacion.setLatLng(e.latlng);
      }

      // MEJORA: Manejo de errores en fetch
      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + e.latitude + '&lon=' + e.longitude)
        .then(res => {
          if (!res.ok) throw new Error('Error en la respuesta del servidor');
          return res.json();
        })
        .then(data => {
          if (data && data.display_name) {
            direccionDetectada = data.display_name;
            if (!origenModificado && window.Android && window.Android.setOrigen) {
              window.Android.setOrigen(direccionDetectada);
            }
          }
        })
        .catch(error => {
          console.warn('Error obteniendo direcci贸n:', error);
          mostrarNotificacion('Error obteniendo la direcci贸n', 'error');
        });
    });

    // MEJORA: Manejo mejorado de errores de ubicaci贸n
    map.on('locationerror', function(e) {
      let mensaje = 'No se pudo obtener tu ubicaci贸n';
      if (e.code === 1) {
        mensaje = 'Permiso de ubicaci贸n denegado. Activa la ubicaci贸n en ajustes.';
      } else if (e.code === 2) {
        mensaje = 'Ubicaci贸n no disponible. Verifica tu conexi贸n.';
      } else if (e.code === 3) {
        mensaje = 'Tiempo de espera agotado para obtener ubicaci贸n.';
      }
      mostrarNotificacion(mensaje, 'error');
    });

    function eliminarUbicacion() {
      origenModificado = true;
      if (markerUbicacion) {
        map.removeLayer(markerUbicacion);
        markerUbicacion = null;
      }
    }

    // MEJORA: Funci贸n mejorada con notificaci贸n
    function restaurarUbicacion() {
      origenModificado = false;
      if (rutaControl) { map.removeControl(rutaControl); rutaControl = null; }
      if (marcadorDestino) { map.removeLayer(marcadorDestino); marcadorDestino = null; }
      
      // NO eliminar markerUbicacion aqu铆, solo permitir que se actualice con la ubicaci贸n
      if (markerUbicacion) {
        // Mantener el marcador pero permitir que se actualice con la ubicaci贸n autom谩tica
        map.removeLayer(markerUbicacion);
        markerUbicacion = null;
      }

      // MEJORA: Limpiar campos en Android al restaurar
      if (window.Android && window.Android.limpiarDirecciones) {
        window.Android.limpiarDirecciones();
      }

      detectarUbicacion();
      mostrarNotificacion('Ubicaci贸n restaurada correctamente', 'success');
    }

    function activarMarcadorFlotante(tipo) {
      modoSeleccion = tipo;
      document.getElementById("marcador-centro").style.display = "block";
    }

    // MEJORA: Funci贸n mejorada con manejo de errores
    function confirmarMarcadorFlotante(tipo) {
      var coords = map.getCenter();
      document.getElementById("marcador-centro").style.display = "none";

      // MEJORA: Mostrar loading durante la obtenci贸n de direcci贸n
      mostrarNotificacion('Obteniendo direcci贸n...');

      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + coords.lat + '&lon=' + coords.lng)
        .then(res => {
          if (!res.ok) throw new Error('Error en la respuesta del servidor');
          return res.json();
        })
        .then(data => {
          if (data && data.display_name) {
            var direccion = data.display_name;
            if (tipo === 'origen') {
              // USAR EL MISMO MARCADOR PARA UBICACIN Y ORIGEN
              if (markerUbicacion) {
                markerUbicacion.setLatLng(coords);
                markerUbicacion.setPopupContent('Origen manual').openPopup();
              } else {
                markerUbicacion = L.marker(coords).addTo(map).bindPopup('Origen manual').openPopup();
              }
              origenModificado = true; // Marcar como modificado manualmente
              if (window.Android && window.Android.setOrigen) window.Android.setOrigen(direccion);
              mostrarNotificacion('Origen establecido correctamente', 'success');
            } else if (tipo === 'destino') {
              if (marcadorDestino) map.removeLayer(marcadorDestino);
              marcadorDestino = L.marker(coords).addTo(map).bindPopup('Destino').openPopup();
              if (window.Android && window.Android.setDestino) window.Android.setDestino(direccion);
              mostrarNotificacion('Destino establecido correctamente', 'success');
            }

            // CREAR RUTA AUTOMTICAMENTE SI HAY ORIGEN Y DESTINO
            crearRutaSiEsNecesario();
            modoSeleccion = null;
          }
        })
        .catch(error => {
          console.error('Error obteniendo direcci贸n:', error);
          mostrarNotificacion('Error al obtener la direcci贸n. Intenta nuevamente.', 'error');
        });
    }

    // FUNCIN: CREAR RUTA AUTOMTICAMENTE
    function crearRutaSiEsNecesario() {
      var origen = obtenerOrigenActual();
      var destino = marcadorDestino ? marcadorDestino.getLatLng() : null;

      if (origen && destino) {
        if (rutaControl) map.removeControl(rutaControl);

        // MEJORA: Notificaci贸n de c谩lculo de ruta
        mostrarNotificacion('Calculando ruta 贸ptima...');

        rutaControl = L.Routing.control({
          waypoints: [origen, destino],
          lineOptions: { styles: [{ color: '#6764FD', weight: 5 }] },
          createMarker: () => null,
          addWaypoints: false,
          routeWhileDragging: false
        }).addTo(map);

        // MEJORA: Evento cuando la ruta est谩 calculada
        rutaControl.on('routesfound', function(e) {
          const routes = e.routes;
          const summary = routes[0].summary;
          // MEJORA: Mostrar informaci贸n de la ruta calculada
          mostrarNotificacion(`Ruta calculada: ${(summary.totalDistance / 1000).toFixed(1)} km`, 'success');
        });

        // MEJORA: Manejo de errores en c谩lculo de ruta
        rutaControl.on('routingerror', function(e) {
          mostrarNotificacion('No se pudo calcular la ruta. Verifica los puntos seleccionados.', 'error');
        });
      }
    }

    // FUNCIN: OBTENER ORIGEN ACTUAL (AUTOMTICO O MANUAL)
    function obtenerOrigenActual() {
      if (markerUbicacion) {
        return markerUbicacion.getLatLng();
      } else if (coordenadasUbicacion && !origenModificado) {
        return L.latLng(coordenadasUbicacion[0], coordenadasUbicacion[1]);
      }
      return null;
    }

    // MEJORA: Funci贸n mejorada con notificaci贸n detallada
    function borrarRutaDesdeApp() {
      if (rutaControl || markerUbicacion || marcadorDestino) {
        let elementosEliminados = [];

        if (rutaControl) {
          map.removeControl(rutaControl);
          rutaControl = null;
          elementosEliminados.push('ruta');
        }

        if (markerUbicacion) { 
          map.removeLayer(markerUbicacion); 
          markerUbicacion = null; 
          elementosEliminados.push('origen');
        }

        if (marcadorDestino) { 
          map.removeLayer(marcadorDestino); 
          marcadorDestino = null; 
          elementosEliminados.push('destino');
        }

        origenModificado = false;

        // NUEVO: LIMPIAR LOS EDITTEXT EN LA APP ANDROID
        if (window.Android && window.Android.limpiarDirecciones) {
          window.Android.limpiarDirecciones();
        }

        // MEJORA: Notificaci贸n mejorada
        mostrarNotificacion('Ruta y marcadores eliminados correctamente', 'success');
      } else {
        mostrarNotificacion('No hay elementos para eliminar', 'info');
      }
    }

    // FUNCIN: LIMPIAR SOLO EL MARCADOR DE ORIGEN
    function limpiarMarcadorOrigen() {
      if (markerUbicacion) {
        map.removeLayer(markerUbicacion);
        markerUbicacion = null;
        origenModificado = false;
        
        // Si hay ruta activa, quitarla
        if (rutaControl) {
          map.removeControl(rutaControl);
          rutaControl = null;
        }
        
        // Limpiar selecci贸n si estaba activa
        if (seleccionandoOrigen) {
          seleccionandoOrigen = false;
          document.getElementById('btn-origen').classList.remove('modo-activo');
          document.getElementById('marcador-centro').classList.remove('marcador-activo');
        }
        
        // Notificar a la app Android que se limpi贸 el origen
        if (window.Android && window.Android.limpiarOrigen) {
          window.Android.limpiarOrigen();
        }
        
        mostrarNotificacion('Origen eliminado', 'success');
      } else {
        mostrarNotificacion('No hay origen para eliminar', 'info');
      }
    }

    // FUNCIN: LIMPIAR SOLO EL MARCADOR DE DESTINO
    function limpiarMarcadorDestino() {
      if (marcadorDestino) {
        map.removeLayer(marcadorDestino);
        marcadorDestino = null;
        
        // Si hay ruta activa, quitarla
        if (rutaControl) {
          map.removeControl(rutaControl);
          rutaControl = null;
        }
        
        // Limpiar selecci贸n si estaba activa
        if (seleccionandoDestino) {
          seleccionandoDestino = false;
          document.getElementById('btn-destino').classList.remove('modo-activo');
          document.getElementById('marcador-centro').classList.remove('marcador-activo');
        }
        
        // Notificar a la app Android que se limpi贸 el destino
        if (window.Android && window.Android.limpiarDestino) {
          window.Android.limpiarDestino();
        }
        
        mostrarNotificacion('Destino eliminado', 'success');
      } else {
        mostrarNotificacion('No hay destino para eliminar', 'info');
      }
    }

    // FUNCIN PARA LIMPIAR AMBOS CAMPOS DESDE ANDROID
    function limpiarDireccionesDesdeAndroid() {
      limpiarMarcadorOrigen();
      limpiarMarcadorDestino();
      
      // Tambi茅n limpiar ubicaci贸n si es necesario
      if (markerUbicacion) {
        map.removeLayer(markerUbicacion);
        markerUbicacion = null;
      }
      
      mostrarNotificacion('Direcciones limpiadas', 'success');
    }

    // NUEVA FUNCIN: MOSTRAR DIRECCIONES DESDE ANDROID
    function mostrarDireccionesEnMapa(origen, destino) {
        console.log("Mostrando en mapa - Origen:", origen, "Destino:", destino);

        if (!origen || !destino || origen.trim() === '' || destino.trim() === '') {
            mostrarNotificacion('Debes proporcionar origen y destino', 'error');
            return;
        }

        // Limpiar marcadores existentes
        if (markerUbicacion) map.removeLayer(markerUbicacion);
        if (marcadorDestino) map.removeLayer(marcadorDestino);
        if (rutaControl) map.removeControl(rutaControl);

        mostrarNotificacion('Buscando ubicaciones en el mapa...');

        // Funci贸n para convertir direcci贸n a coordenadas
        function geocodificarDireccion(direccion, esOrigen) {
            return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}&limit=1&accept-language=es`)
                .then(res => {
                    if (!res.ok) throw new Error('Error en el servidor');
                    return res.json();
                })
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        const coords = L.latLng(lat, lon);

                        // Crear marcador
                        const marcador = L.marker(coords).addTo(map);
                        const tipo = esOrigen ? 'Origen' : 'Destino';
                        const icono = esOrigen ? '' : '';

                        marcador.bindPopup(`${icono} <strong>${tipo}</strong><br>${direccion}`).openPopup();

                        if (esOrigen) {
                            // USAR markerUbicacion PARA EL ORIGEN
                            if (markerUbicacion) {
                                markerUbicacion.setLatLng(coords);
                                markerUbicacion.setPopupContent(`${icono} <strong>${tipo}</strong><br>${direccion}`).openPopup();
                            } else {
                                markerUbicacion = L.marker(coords).addTo(map)
                                    .bindPopup(`${icono} <strong>${tipo}</strong><br>${direccion}`).openPopup();
                            }
                            origenModificado = true;
                        } else {
                            if (marcadorDestino) map.removeLayer(marcadorDestino);
                            marcadorDestino = L.marker(coords).addTo(map)
                                .bindPopup(`${icono} <strong>${tipo}</strong><br>${direccion}`).openPopup();
                        }

                        return coords;
                    } else {
                        throw new Error(`No se encontr贸: "${direccion}"`);
                    }
                });
        }

        // Procesar ambas direcciones
        Promise.all([
            geocodificarDireccion(origen, true),
            geocodificarDireccion(destino, false)
        ])
        .then(([coordsOrigen, coordsDestino]) => {
            // Centrar el mapa para mostrar ambos puntos
            const group = new L.featureGroup([markerUbicacion, marcadorDestino]);
            map.fitBounds(group.getBounds().pad(0.1));

            // Crear ruta entre los puntos
            if (rutaControl) map.removeControl(rutaControl);

            rutaControl = L.Routing.control({
                waypoints: [coordsOrigen, coordsDestino],
                lineOptions: { styles: [{ color: '#6764FD', weight: 5 }] },
                createMarker: () => null,
                addWaypoints: false,
                routeWhileDragging: false,
                show: false
            }).addTo(map);

            // Mostrar informaci贸n cuando la ruta est茅 lista
            rutaControl.on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                const distanciaKm = (summary.totalDistance / 1000).toFixed(1);
                const tiempoMin = Math.round(summary.totalTime / 60);
                mostrarNotificacion(`Ruta calculada: ${distanciaKm} km, ${tiempoMin} min`, 'success');
            });

            rutaControl.on('routingerror', function(e) {
                mostrarNotificacion('No se pudo calcular la ruta entre las ubicaciones', 'error');
            });

            mostrarNotificacion('Ubicaciones encontradas en el mapa', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion(error.message, 'error');
        });
    }

    // Inicializar la ubicaci贸n al cargar la p谩gina
    detectarUbicacion();

    // MEJORA: Manejo de errores global
    window.addEventListener('error', function(e) {
      console.error('Error global:', e.error);
      mostrarNotificacion('Ha ocurrido un error inesperado', 'error');
    });

  </script>
</body>
</html>